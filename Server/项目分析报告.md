# Serveré¡¹ç›®åˆ†ææŠ¥å‘Š
**åˆ†ææ—¥æœŸ**: 2025å¹´12æœˆ26æ—¥  
**Javaç‰ˆæœ¬**: 25  
**Spring Bootç‰ˆæœ¬**: 4.0.1

---

## ä¸€ã€Java 25æ–°ç‰¹æ€§ä½¿ç”¨æƒ…å†µåˆ†æ

### âœ… å·²ä½¿ç”¨çš„ç‰¹æ€§

1. **è™šæ‹Ÿçº¿ç¨‹ï¼ˆVirtual Threadsï¼‰**
   - âœ… **å·²ä½¿ç”¨**: `AsyncConfig.java` ä¸­ä½¿ç”¨äº† `Executors.newVirtualThreadPerTaskExecutor()`
   - âœ… **å·²é…ç½®**: `application.yml` ä¸­å¯ç”¨äº† `spring.threads.virtual: true`
   - âœ… **å·²é…ç½®**: `build.gradle` ä¸­é…ç½®äº†è™šæ‹Ÿçº¿ç¨‹ç›¸å…³çš„JVMå‚æ•°
   - ğŸ“ **ä½ç½®**: 
     - `Server/src/main/java/com/northgod/server/config/AsyncConfig.java:16`
     - `Server/src/main/resources/application.yml:10`

2. **Switchè¡¨è¾¾å¼ï¼ˆJava 14+ï¼‰**
   - âœ… **å·²ä½¿ç”¨**: `TransactionService.java` ä¸­ä½¿ç”¨äº†ç°ä»£switchè¡¨è¾¾å¼
   - ğŸ“ **ä½ç½®**: `Server/src/main/java/com/northgod/server/service/TransactionService.java:324-328`

3. **æ–‡æœ¬å—ï¼ˆText Blocks, Java 15+ï¼‰**
   - âœ… **å·²ä½¿ç”¨**: `BookRepository.java` ä¸­ä½¿ç”¨äº†æ–‡æœ¬å—è¯­æ³•
   - ğŸ“ **ä½ç½®**: `Server/src/main/java/com/northgod/server/repository/BookRepository.java:55-61, 73-79`

### âŒ æœªä½¿ç”¨ä½†å»ºè®®ä½¿ç”¨çš„ç‰¹æ€§

1. **ä½œç”¨åŸŸå€¼ï¼ˆScoped Valuesï¼‰** - Java 25æ–°ç‰¹æ€§
   - âŒ **æœªä½¿ç”¨**: é¡¹ç›®ä¸­æœªä½¿ç”¨ `ScopedValue` æ›¿ä»£ `ThreadLocal`
   - ğŸ’¡ **å»ºè®®**: åœ¨éœ€è¦çº¿ç¨‹é—´ä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯çš„åœºæ™¯ä¸­ï¼Œä½¿ç”¨ `ScopedValue` æ›¿ä»£ `ThreadLocal`ï¼Œç‰¹åˆ«æ˜¯åœ¨è™šæ‹Ÿçº¿ç¨‹ç¯å¢ƒä¸­æ€§èƒ½æ›´ä¼˜
   - ğŸ“ **é€‚ç”¨åœºæ™¯**: 
     - è¯·æ±‚è¿½è¸ªIDä¼ é€’
     - ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯ä¼ é€’
     - æ—¥å¿—ä¸Šä¸‹æ–‡ä¼ é€’

2. **ç´§å‡‘å¯¹è±¡å¤´ï¼ˆCompact Object Headersï¼‰**
   - âŒ **æœªé…ç½®**: æœªåœ¨JVMå‚æ•°ä¸­å¯ç”¨ `-XX:+UseCompactObjectHeaders`
   - ğŸ’¡ **å»ºè®®**: åœ¨ `build.gradle` çš„ `bootRun` ä»»åŠ¡ä¸­æ·»åŠ æ­¤å‚æ•°ï¼Œå¯å‡å°‘å°å¯¹è±¡å†…å­˜å ç”¨

3. **åˆ†ä»£Shenandoah GC**
   - âŒ **æœªé…ç½®**: æœªé…ç½®åˆ†ä»£Shenandoahåƒåœ¾å›æ”¶å™¨
   - ğŸ’¡ **å»ºè®®**: å¯¹äºé«˜ååé‡åº”ç”¨ï¼Œå¯è€ƒè™‘ä½¿ç”¨ `-XX:+UseShenandoahGC -XX:ShenandoahGCMode=generational`

4. **å®ä¾‹ä¸»æ–¹æ³•ï¼ˆInstance Main Methodsï¼‰**
   - âŒ **æœªä½¿ç”¨**: ä¸»ç±»ä»ä½¿ç”¨ä¼ ç»Ÿçš„ `public static void main` æ–¹æ³•
   - ğŸ’¡ **å»ºè®®**: å¯ä»¥ç®€åŒ–ä¸ºå®ä¾‹ä¸»æ–¹æ³•ï¼ˆè™½ç„¶å¯¹ç°æœ‰ä»£ç å½±å“ä¸å¤§ï¼‰

---

## äºŒã€Spring Boot 4.0æ–°ç‰¹æ€§ä½¿ç”¨æƒ…å†µåˆ†æ

### âœ… å·²ä½¿ç”¨çš„ç‰¹æ€§

1. **RestClient** - Spring Boot 4.0æ–°å¢çš„HTTPå®¢æˆ·ç«¯
   - âœ… **å·²ä½¿ç”¨**: `RestClientConfig.java` ä¸­é…ç½®äº† `RestClient.Builder`
   - âœ… **å·²ä½¿ç”¨**: `TransactionController.java` ä¸­ä½¿ç”¨äº† `RestClient`
   - ğŸ“ **ä½ç½®**: 
     - `Server/src/main/java/com/northgod/server/config/RestClientConfig.java:27-40`
     - `Server/src/main/java/com/northgod/server/controller/TransactionController.java:34, 253-261`

2. **è™šæ‹Ÿçº¿ç¨‹æ”¯æŒ**
   - âœ… **å·²é…ç½®**: Spring Boot 4.0åŸç”Ÿæ”¯æŒè™šæ‹Ÿçº¿ç¨‹ï¼Œå·²åœ¨é…ç½®ä¸­å¯ç”¨
   - ğŸ“ **ä½ç½®**: `Server/src/main/resources/application.yml:9-10`

3. **JdkClientHttpRequestFactory**
   - âœ… **å·²ä½¿ç”¨**: ä½¿ç”¨äº†Java 21+çš„ `JdkClientHttpRequestFactory`ï¼Œæ”¯æŒè™šæ‹Ÿçº¿ç¨‹
   - ğŸ“ **ä½ç½®**: `Server/src/main/java/com/northgod/server/config/RestClientConfig.java:31, 46-81`

### âŒ æœªä½¿ç”¨ä½†å»ºè®®ä½¿ç”¨çš„ç‰¹æ€§

1. **ProblemDetail** - Spring 6.0+çš„é”™è¯¯å“åº”æ ‡å‡†åŒ–
   - âŒ **æœªä½¿ç”¨**: `GlobalExceptionHandler.java` ä¸­ä½¿ç”¨äº†è‡ªå®šä¹‰çš„ `ErrorResponse` ç±»
   - ğŸ’¡ **å»ºè®®**: ä½¿ç”¨Spring 6.0+çš„ `ProblemDetail` ç±»æ¥æ ‡å‡†åŒ–é”™è¯¯å“åº”ï¼Œç¬¦åˆRFC 7807æ ‡å‡†

2. **Observability API**
   - âŒ **æœªä½¿ç”¨**: æœªä½¿ç”¨Spring Boot 4.0çš„Observability API
   - ğŸ’¡ **å»ºè®®**: ä½¿ç”¨ `@Observed` æ³¨è§£å’ŒMicrometerçš„Observability APIæ¥å¢å¼ºå¯è§‚æµ‹æ€§

3. **Native Imageæ”¯æŒ**
   - âŒ **æœªä½¿ç”¨**: æœªé…ç½®GraalVM Native Imageæ”¯æŒ
   - ğŸ’¡ **å»ºè®®**: å¦‚éœ€æ›´å¿«çš„å¯åŠ¨æ—¶é—´å’Œæ›´ä½çš„å†…å­˜å ç”¨ï¼Œå¯è€ƒè™‘é…ç½®Native Image

---

## ä¸‰ã€Bugå’Œæ½œåœ¨é—®é¢˜åˆ†æ

### ğŸ› å‘ç°çš„Bug

1. **build.gradleä¸­çš„è™šæ‹Ÿçº¿ç¨‹é…ç½®é—®é¢˜**
   - ğŸ“ **ä½ç½®**: `Server/build.gradle:60`
   - âŒ **é—®é¢˜**: `--enable-preview` å‚æ•°åœ¨Java 25ä¸­ä¸å†éœ€è¦ï¼Œè™šæ‹Ÿçº¿ç¨‹å·²ç»æ˜¯æ­£å¼ç‰¹æ€§
   - ğŸ”§ **ä¿®å¤**: ç§»é™¤ `--enable-preview` å‚æ•°

2. **TransactionServiceä¸­çš„ç©ºæŒ‡é’ˆé£é™©**
   - ğŸ“ **ä½ç½®**: `Server/src/main/java/com/northgod/server/service/TransactionService.java:86-87`
   - âŒ **é—®é¢˜**: `transaction.getBook()` å¯èƒ½ä¸ºnullï¼Œä½†ç›´æ¥è°ƒç”¨ `getId()` å¯èƒ½å¯¼è‡´NPE
   - ğŸ”§ **ä¿®å¤**: åœ¨ `validateTransaction` æ–¹æ³•ä¸­å·²æ£€æŸ¥ï¼Œä½†å»ºè®®åœ¨è°ƒç”¨å‰å†æ¬¡éªŒè¯

3. **BookControllerä¸­çš„Map.of()é™åˆ¶**
   - ğŸ“ **ä½ç½®**: `Server/src/main/java/com/northgod/server/controller/BookController.java:48-55, 106-111`
   - âš ï¸ **é—®é¢˜**: `Map.of()` æœ€å¤šåªæ”¯æŒ10ä¸ªé”®å€¼å¯¹ï¼Œä¸”ä¸æ”¯æŒnullå€¼
   - ğŸ”§ **ä¿®å¤**: ä½¿ç”¨ `Map.ofEntries()` æˆ– `HashMap` æ›¿ä»£

4. **RestClientConfigä¸­çš„åå°„ä½¿ç”¨**
   - ğŸ“ **ä½ç½®**: `Server/src/main/java/com/northgod/server/config/RestClientConfig.java:52-78`
   - âš ï¸ **é—®é¢˜**: ä½¿ç”¨åå°„æ¥è®¾ç½®è¶…æ—¶ï¼Œä»£ç å¤æ‚ä¸”å®¹æ˜“å‡ºé”™
   - ğŸ”§ **ä¿®å¤**: Spring Boot 4.0åº”è¯¥å·²ç»æ”¯æŒDurationå‚æ•°ï¼Œç›´æ¥ä½¿ç”¨å³å¯

5. **HealthControllerä¸­çš„ç‰ˆæœ¬å·ç¡¬ç¼–ç **
   - ğŸ“ **ä½ç½®**: `Server/src/main/java/com/northgod/server/controller/HealthController.java:161`
   - âš ï¸ **é—®é¢˜**: Spring Bootç‰ˆæœ¬å·ç¡¬ç¼–ç ä¸º "4.0.0"ï¼Œå®é™…ä½¿ç”¨çš„æ˜¯ "4.0.1"
   - ğŸ”§ **ä¿®å¤**: ä½¿ç”¨ `@Value("${spring.boot.version}")` æˆ–ä» `SpringBootVersion` è·å–

6. **TransactionServiceä¸­çš„é™¤é›¶é£é™©**
   - ğŸ“ **ä½ç½®**: `Server/src/main/java/com/northgod/server/service/TransactionService.java:277`
   - âŒ **é—®é¢˜**: `dailySummaries.size()` å¯èƒ½ä¸º0ï¼Œå¯¼è‡´é™¤é›¶å¼‚å¸¸
   - ğŸ”§ **ä¿®å¤**: æ·»åŠ é™¤é›¶æ£€æŸ¥

### âš ï¸ æ½œåœ¨ä¼˜åŒ–ç‚¹

1. **å¼‚å¸¸å¤„ç†å¯ä»¥æ”¹è¿›**
   - ğŸ“ **ä½ç½®**: å¤šä¸ªControllerä¸­çš„try-catchå—
   - ğŸ’¡ **å»ºè®®**: ä½¿ç”¨ `@ExceptionHandler` ç»Ÿä¸€å¤„ç†ï¼Œå‡å°‘é‡å¤ä»£ç 

2. **ç¼“å­˜ç­–ç•¥å¯ä»¥ä¼˜åŒ–**
   - ğŸ“ **ä½ç½®**: `BookService.java` ä¸­çš„ç¼“å­˜æ³¨è§£
   - ğŸ’¡ **å»ºè®®**: è€ƒè™‘ä½¿ç”¨Spring Cacheçš„ `@CachePut` å’Œæ¡ä»¶ç¼“å­˜

3. **æ‰¹é‡æ“ä½œæ€§èƒ½**
   - ğŸ“ **ä½ç½®**: `BookService.deleteBooksBatch()` æ–¹æ³•
   - ğŸ’¡ **å»ºè®®**: ä½¿ç”¨æ‰¹é‡åˆ é™¤SQLï¼Œè€Œä¸æ˜¯å¾ªç¯è°ƒç”¨å•ä¸ªåˆ é™¤

4. **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**
   - ğŸ“ **ä½ç½®**: `BookService.calculateTotalInventoryValue()` æ–¹æ³•
   - ğŸ’¡ **å»ºè®®**: ä½¿ç”¨æ•°æ®åº“èšåˆå‡½æ•°è€Œä¸æ˜¯åœ¨å†…å­˜ä¸­è®¡ç®—

5. **æ—¥å¿—çº§åˆ«**
   - ğŸ“ **ä½ç½®**: `application.yml:24`
   - âš ï¸ **é—®é¢˜**: ç”Ÿäº§ç¯å¢ƒä¸åº”ä½¿ç”¨DEBUGçº§åˆ«æ—¥å¿—
   - ğŸ’¡ **å»ºè®®**: ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–Profileæ¥æ§åˆ¶æ—¥å¿—çº§åˆ«

---

## å››ã€ä¼˜åŒ–å»ºè®®å’Œä»£ç æ”¹è¿›

### 1. ä½¿ç”¨Java 25çš„ScopedValueæ›¿ä»£ThreadLocal

**å½“å‰ä»£ç **ï¼ˆClientç«¯æœ‰ThreadLocalï¼ŒServerç«¯æ²¡æœ‰ï¼‰:
```java
// Clientç«¯ä½¿ç”¨äº†ThreadLocalï¼Œå¯ä»¥å‡çº§åˆ°ScopedValue
private static final ThreadLocal<String> USER_CONTEXT = new ThreadLocal<>();
```

**å»ºè®®æ”¹è¿›**:
```java
// ä½¿ç”¨Java 25çš„ScopedValue
private static final ScopedValue<String> USER_CONTEXT = ScopedValue.newInstance();

// ä½¿ç”¨æ–¹å¼
ScopedValue.runWhere(USER_CONTEXT, username, () -> {
    // åœ¨æ­¤ä½œç”¨åŸŸå†…å¯ä»¥ä½¿ç”¨USER_CONTEXT.get()
});
```

### 2. ä¿®å¤build.gradleä¸­çš„è™šæ‹Ÿçº¿ç¨‹é…ç½®

**å½“å‰ä»£ç **:
```gradle
jvmArgs = [
    '--enable-preview', // Java 25 è™šæ‹Ÿçº¿ç¨‹ä»å¯èƒ½éœ€è¦æ­¤å‚æ•°
    '-Dspring.threads.virtual.enabled=true'
]
```

**å»ºè®®æ”¹è¿›**:
```gradle
jvmArgs = [
    '-Dspring.threads.virtual.enabled=true'
    // Java 25ä¸­è™šæ‹Ÿçº¿ç¨‹å·²ç»æ˜¯æ­£å¼ç‰¹æ€§ï¼Œä¸éœ€è¦--enable-preview
]
```

### 3. ä½¿ç”¨Spring Boot 4.0çš„ProblemDetail

**å½“å‰ä»£ç **:
```java
private ResponseEntity<Map<String, Object>> createErrorResponse(String message, HttpStatus status) {
    Map<String, Object> response = new HashMap<>();
    // ...
}
```

**å»ºè®®æ”¹è¿›**:
```java
private ResponseEntity<ProblemDetail> createErrorResponse(String message, HttpStatus status) {
    ProblemDetail problemDetail = ProblemDetail.forStatus(status);
    problemDetail.setTitle("ä¸šåŠ¡é”™è¯¯");
    problemDetail.setDetail(message);
    return ResponseEntity.of(problemDetail).build();
}
```

### 4. ä¼˜åŒ–æ‰¹é‡åˆ é™¤æ“ä½œ

**å½“å‰ä»£ç **:
```java
public int deleteBooksBatch(List<Long> ids) {
    int deletedCount = 0;
    for (Long id : ids) {
        try {
            deleteBook(id);
            deletedCount++;
        } catch (Exception e) {
            logger.error("æ‰¹é‡åˆ é™¤ä¹¦ç±å¤±è´¥: {}", id, e);
        }
    }
    return deletedCount;
}
```

**å»ºè®®æ”¹è¿›**:
```java
@Modifying
@Query("DELETE FROM Book b WHERE b.id IN :ids")
int deleteBooksBatch(@Param("ids") List<Long> ids);
```

### 5. ä½¿ç”¨æ•°æ®åº“èšåˆå‡½æ•°ä¼˜åŒ–åº“å­˜ä»·å€¼è®¡ç®—

**å½“å‰ä»£ç **:
```java
public BigDecimal calculateTotalInventoryValue() {
    List<Book> books = bookRepository.findAll();
    BigDecimal totalValue = BigDecimal.ZERO;
    for (Book book : books) {
        // åœ¨å†…å­˜ä¸­è®¡ç®—
    }
    return totalValue;
}
```

**å»ºè®®æ”¹è¿›**:
```java
@Query("SELECT SUM(b.purchasePrice * b.stockQuantity) FROM Book b WHERE b.isActive = true")
BigDecimal calculateTotalInventoryValue();
```

---

## äº”ã€æ€»ç»“

### å·²å……åˆ†åˆ©ç”¨çš„ç‰¹æ€§
- âœ… Java 25è™šæ‹Ÿçº¿ç¨‹
- âœ… Spring Boot 4.0çš„RestClient
- âœ… ç°ä»£Javaè¯­æ³•ï¼ˆswitchè¡¨è¾¾å¼ã€æ–‡æœ¬å—ï¼‰

### å»ºè®®ç«‹å³æ”¹è¿›
1. ğŸ”´ **é«˜ä¼˜å…ˆçº§**: ä¿®å¤build.gradleä¸­çš„ `--enable-preview` å‚æ•°
2. ğŸ”´ **é«˜ä¼˜å…ˆçº§**: ä¿®å¤ `TransactionService` ä¸­çš„é™¤é›¶é£é™©
3. ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§**: ä½¿ç”¨ `ScopedValue` æ›¿ä»£ `ThreadLocal`ï¼ˆå¦‚éœ€è¦ï¼‰
4. ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§**: ä¼˜åŒ–æ‰¹é‡æ“ä½œæ€§èƒ½
5. ğŸŸ¢ **ä½ä¼˜å…ˆçº§**: ä½¿ç”¨ `ProblemDetail` æ ‡å‡†åŒ–é”™è¯¯å“åº”

### æ€§èƒ½ä¼˜åŒ–å»ºè®®
1. å¯ç”¨ç´§å‡‘å¯¹è±¡å¤´å‡å°‘å†…å­˜å ç”¨
2. è€ƒè™‘ä½¿ç”¨åˆ†ä»£Shenandoah GC
3. ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼Œå‡å°‘å†…å­˜è®¡ç®—
4. æ”¹è¿›ç¼“å­˜ç­–ç•¥

### ä»£ç è´¨é‡æ”¹è¿›
1. ç»Ÿä¸€å¼‚å¸¸å¤„ç†
2. å‡å°‘é‡å¤ä»£ç 
3. æ”¹è¿›æ—¥å¿—é…ç½®
4. æ·»åŠ æ›´å¤šå•å…ƒæµ‹è¯•

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025å¹´12æœˆ26æ—¥




















